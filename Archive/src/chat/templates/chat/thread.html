{% extends "base.html" %}

{% block content %}

<style>
    ul {list-style-type: none;}
    .card-body { overflow-y: auto; max-height: 500px;}
</style>
<div class="card" id="chat-box">
    <div class="card-header">
        Thread for {% if user != object.first %}{{ object.first }}{% else %}{{ object.second }}{% endif %}
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush" id='chat-items'>
            {% for chat in object.chatmessage_set.all %}
                <li class="list-group-item"><svg class="bi bi-person-square" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M14 1H2a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V2a1 1 0 00-1-1zM2 0a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2H2z" clip-rule="evenodd"/>
                    <path fill-rule="evenodd" d="M2 15v-1c0-1 1-4 6-4s6 3 6 4v1H2zm6-6a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                  </svg> <b class="text-muted">{{ chat.user }}</b> - {{ chat.message }}</li>
            {% endfor %}
        </ul>
    </div>
    <div class="card-footer text-muted">
        <form id='form' method='POST'> {% csrf_token %}
            <input type="hidden" value="{{ user.username }}" id="myUsername"/>
            {{form.as_p }}
            <input type='submit' class='btn btn-block btn-primary'/>
        </form>
    </div>
</div>


{% endblock %}

{% block script %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.js"></script>

<script>
// websocket scripts
console.log(window.location)

var loc = window.location
var formData = $("#form")
var msgInput = $("#id_message")
var chatHolder = $("#chat-items")
var me = $("#myUsername").val()

formData.attr('autocomplete', 'off')

var wsStart = 'ws://'
if(loc.protocol == 'https:') {
    wsStart = 'wss://'
}
var endpoint = wsStart + loc.host + loc.pathname
var sockets = new ReconnectingWebSocket(endpoint)

sockets.onmessage = function(e) {
    console.log('message', e)

    // Parsing the new chat data which contains
    // 1. The message itself
    // 2. The user who authored the message
    let newChatData = JSON.parse(e.data)

    /*For the messages by other users we need to communicate with backend*/
    // creating an entry for a new message on the Browser window
    let messageEntry = document.createElement("li")
    messageEntry.textContent = "[" + newChatData.username + "] " + newChatData.message
    // console.log(messageEntry)
    // Putting the created entry on the DOM
    chatHolder.append(messageEntry)
    
}
sockets.onopen = function(e) {
    console.log('open', e)
    formData.submit(function(event){
        event.preventDefault()
        let msgText = msgInput.val()

        let finalData = {
            'message': msgText
        }
        sockets.send(JSON.stringify(finalData))
        formData[0].reset()
    })
}
sockets.onerror = function(e) {
    console.log('error', e)
}
sockets.onclose = function(e) {
    console.log('close', e)
}
</script>
{% endblock %}